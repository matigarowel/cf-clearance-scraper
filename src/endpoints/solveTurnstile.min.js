function solveTurnstileMin({ url, proxy, siteKey }) {
    return new Promise(async (resolve, reject) => {

        if (!url) return reject('Missing url parameter')
        if (!siteKey) return reject('Missing siteKey parameter')

        const context = await global.browser.createBrowserContext().catch(() => null);
        if (!context) return reject('Failed to create browser context')

        let isResolved = false

        const { proxyRequest } = await import('puppeteer-proxy')
        const { RequestInterceptionManager } = await import('puppeteer-intercept-and-modify-requests')


        var cl = setTimeout(async () => {
            if (!isResolved) {
                await context.close()
                reject("Timeout Error")
            }
        }, (global.timeOut || 60000))

        try {
            const page = await context.newPage();
            const client = await page.target().createCDPSession()
            const interceptManager = new RequestInterceptionManager(client)

            await page.setRequestInterception(true);

            page.on('request', async (request) => {
                try {
                    // if ([url, url + '/'].includes(request.url())) return request.abort()

                    if (proxy) {
                        await proxyRequest({
                            page,
                            proxyUrl: `http://${proxy.username ? `${proxy.username}:${proxy.password}@` : ""}${proxy.host}:${proxy.port}`,
                            request,
                        });
                    } else {
                        request.continue()
                    }
                } catch (e) { }
            });

            await page.goto(url, {
                waitUntil: 'domcontentloaded'
            })

            await page.addScriptTag({
                content: `

                    const fingerprinttwo = document.createElement('div');
                    fingerprinttwo.id = 'fingerprinttwo';
                    fingerprinttwo.textContent = new Fingerprint({canvas: true,screen_resolution: true,ie_activex: true}).get();
                    document.body.appendChild(fingerprinttwo);

                    const fingerprintone = document.createElement('div');fingerprintone.id = 'fingerprintone';
                    fingerprintone.textContent = fingerprint;document.body.appendChild(fingerprintone);

                `
            }).then(async () => {
                let fingerprintone = await page.evaluate(() => {
                    let value = document.querySelector(`#fingerprintone`)?.textContent;
                    return value
                })

                console.log("fingerprintone", fingerprintone)

                let fingerprinttwo = await page.evaluate(() => {
                    let value = document.querySelector(`#fingerprinttwo`)?.textContent;
                    return value
                })

                console.log("fingerprinttwo", fingerprinttwo)

            }).catch((ex) => {
                console.log(ex)
            })

            await interceptManager.intercept(
                {
                    urlPattern: url,
                    resourceType: 'Document',
                    modifyResponse({ body }) {
                        return {
                            body: String(require('fs').readFileSync('./src/data/fakePage.html')).replace(/<site-key>/g, siteKey),
                            status: 200
                        }
                    },
                }
            )

            await page.goto(url, {
                waitUntil: 'domcontentloaded'
            })

            // await page.addScriptTag({
            //     content: `



            //         const script = document.createElement('script'); // Create a new <script> element
            //         script.src = 'https://static1.freebitco.in/min/combined1393766573.js'; // Set the src attribute
            //         script.type = 'text/javascript'; // Set the script type (optional, default is 'text/javascript')
            //         script.async = true; // Optional: Load the script asynchronously
            //         document.head.appendChild(script); // Append the script to the <head> or <body>

            //         const script1 = document.createElement('script'); // Create a new <script> element
            //         script1.src = 'https://static1.freebitco.in/min/compressed_bottom3.js'; // Set the src attribute
            //         script1.type = 'text/javascript'; // Set the script type (optional, default is 'text/javascript')
            //         script1.async = true; // Optional: Load the script asynchronously
            //         document.head.appendChild(script1); // Append the script to the <head> or <body>

            //     `
            // }).then(async () => {

            // }).catch((ex) => {
            //     console.log(ex)
            // })

            await page.waitForSelector('[name="cf-response"]', {
                timeout: global.timeOut
            })

            const token = await page.evaluate(() => {
                try {
                    return document.querySelector('[name="cf-response"]').value
                } catch (e) {
                    return null
                }
            })

            // await page.addScriptTag({
            //     content: `

            //         const fingerprinttwo = document.createElement('div');
            //         fingerprinttwo.id = 'fingerprinttwo';
            //         fingerprinttwo.textContent = new Fingerprint({canvas: true,screen_resolution: true,ie_activex: true}).get();
            //         document.body.appendChild(fingerprinttwo);

            //         const fingerprintone = document.createElement('div');fingerprintone.id = 'fingerprintone';
            //         fingerprintone.textContent = fingerprint;document.body.appendChild(fingerprintone);

            //     `
            // }).then(async () => {
            //     let textContent = await page.evaluate(() => {
            //         let value = document.querySelector(`#fingerprintone`)?.textContent;
            //         return value
            //     })

            //     console.log("textContent", textContent)

            // }).catch((ex) => {
            //     console.log(ex)
            // })

            isResolved = true
            clearInterval(cl)
            await context.close()
            if (!token || token.length < 10) return reject('Failed to get token')
            return resolve(token)
        } catch (e) {
            if (!isResolved) {
                // await context.close()
                clearInterval(cl)
                reject(e.message)
            }
        }

    })
}

module.exports = solveTurnstileMin